# CSV Export and Decoupled Plotting Implementation Summary

## Overview

Successfully implemented **CSV export functionality for 2D simulations** and **decoupled plotting system** as requested by the user. The system now provides complete parity between 2D CSV export and 3D VTK export, with independent visualization capabilities.

## ‚úÖ **Key Achievements**

### 1. **CSV Export for 2D Simulation Results**
- **Parallel to VTK**: CSV export works exactly like VTK files for 3D simulations
- **Complete Gene Networks**: Exports all 106 gene nodes with their states
- **Cell Positions**: Logical coordinates and phenotype information
- **Substance Fields**: Concentration distributions for all substances
- **Timestep Export**: Controlled by `save_cellstate_interval` configuration

### 2. **Decoupled Plotting System**
- **Independent Tool**: `tools/csv_plotter.py` runs separately from simulation
- **Multiple Formats**: Snapshot plots, animations, population statistics
- **Flexible Input**: Works with any CSV files generated by the system
- **Post-Processing**: Can generate visualizations after simulation completes

### 3. **Enhanced Initial State Support**
- **CSV Initial States**: Simulation can now load initial conditions from CSV files
- **VTK Compatibility**: Maintains full backward compatibility with VTK files
- **Automatic Detection**: File format detected by extension (.csv vs .vtk)

## üìÅ **New Files Created**

### `tools/csv_export.py`
**Purpose**: CSV export functionality for 2D simulation results

**Key Classes:**
- `CSVCellStateExporter`: Exports cell positions, phenotypes, and gene states
- `CSVSubstanceFieldExporter`: Exports substance concentration fields

**Key Functions:**
```python
def export_microc_csv_cell_state(population, output_dir: str, step: int, cell_size_um: float = 20.0)
def export_microc_csv_substance_fields(simulator, output_dir: str, step: int)
```

### `tools/csv_plotter.py`
**Purpose**: Decoupled plotting tool for CSV simulation results

**Key Features:**
- Snapshot plots of cell states and substance fields
- Animation generation from time series data
- Population statistics over time
- Independent of simulation runtime

**Usage:**
```bash
python tools/csv_plotter.py --cells-dir results/csv_cells --substances-dir results/csv_substances --output plots/ --snapshots --statistics
```

## üîß **Modified Files**

### `run_microc.py` (Master Runner)
**Changes:**
- Added `--plot-csv` flag for decoupled plotting functionality
- Added plotting-specific arguments: `--cells-dir`, `--substances-dir`, `--plot-output`
- Added plot type flags: `--snapshots`, `--animation`, `--statistics`
- Improved path resolution to work from any directory
- Added validation and error handling for required arguments

**New Arguments:**
```bash
--plot-csv              # Enable CSV plotting mode
--cells-dir DIR         # Directory with CSV cell state files (required)
--substances-dir DIR    # Directory with CSV substance files (optional)
--plot-output DIR       # Output directory for plots (default: plots)
--snapshots             # Generate snapshot plots
--animation             # Generate animation from time series
--statistics            # Generate population statistics plots
```

### `tools/run_sim.py`
**Changes:**
- Added CSV initial state loading support
- Integrated CSV export for 2D simulations alongside VTK export for 3D
- Automatic format detection based on domain dimensions

**Key Code:**
```python
# Determine export format based on domain dimensions
if config.domain.dimensions == 2:
    print(f"\n[CSV] Exporting 2D simulation results at step {step}...")
    from csv_export import export_microc_csv_cell_state, export_microc_csv_substance_fields
    
    # Export CSV cell state
    csv_output_dir = config.output_dir / "csv_cells"
    csv_file = export_microc_csv_cell_state(population, output_dir=str(csv_output_dir), step=step, cell_size_um=cell_size_um)
    
    # Export CSV substance concentration fields
    substance_output_dir = config.output_dir / "csv_substances"
    substance_files = export_microc_csv_substance_fields(simulator, output_dir=str(substance_output_dir), step=step)
else:
    # 3D simulations use VTK export
    from vtk_export import export_microc_simulation_state, export_microc_substance_fields
```

## üìä **CSV Export Format**

### Cell State Files (`csv_cells/cells_step_XXXXX.csv`)
```csv
# MicroC 2D Cell States - Step 0
# Generated: 2025-10-12T18:58:25.508236
# Cell count: 13
# Cell size: 20.0 um
# Coordinate system: logical grid positions
cell_id,x,y,phenotype,age,generation,gene_AKT,gene_AP1,...,gene_p70
cell_000000,8.0,8.0,Proliferation,0.1,0,false,true,true,...,false
cell_000001,7.0,8.0,Proliferation,0.1,0,true,false,true,...,true
```

### Substance Field Files (`csv_substances/SUBSTANCE_step_XXXXX.csv`)
```csv
# MicroC 2D Substance Field - Lactate - Step 0
# Generated: 2025-10-12T18:58:25.508236
# Grid size: 10x10
# Cell size: 20.0 um
# Coordinate system: logical grid positions
x,y,concentration
0,0,1.0234
0,1,1.0456
```

## üöÄ **Usage Examples**

### 1. **Run 2D Simulation with CSV Export**
```bash
# Create 2D configuration with CSV initial state
python run_microc.py --sim tests/csv_export_test/csv_export_test_config.yaml
```

### 2. **Generate Plots from CSV Results**

**Using Master Runner (Recommended):**
```bash
# Snapshot plots via Master Runner
python run_microc.py --plot-csv --cells-dir results/csv_cells --plot-output plots --snapshots

# Comprehensive plots with substances and statistics
python run_microc.py --plot-csv --cells-dir results/csv_cells --substances-dir results/csv_substances --plot-output plots --snapshots --animation --statistics
```

**Using Direct Tool:**
```bash
# Snapshot plots
python tools/csv_plotter.py --cells-dir results/csv_cells --output plots/ --snapshots

# Animation and statistics
python tools/csv_plotter.py --cells-dir results/csv_cells --substances-dir results/csv_substances --output plots/ --animation --statistics
```

### 3. **Create Initial State CSV with Complete Gene Network**
```bash
# Generate CSV with all 106 genes from BND file
python run_microc.py --generate-csv --pattern spheroid --count 50 --genes tests/jayatilake_experiment/jaya_microc.bnd --output initial_cells.csv
```

## üîÑ **Complete Workflow**

### **2D Simulation Workflow:**
1. **Initial Conditions**: CSV with complete gene networks ‚úÖ
2. **Simulation**: MicroC processes and exports CSV with gene states ‚úÖ  
3. **Visualization**: Decoupled plotting tool generates visualizations ‚úÖ

### **3D Simulation Workflow:**
1. **Initial Conditions**: VTK files (unchanged) ‚úÖ
2. **Simulation**: MicroC processes and exports VTK with gene states ‚úÖ
3. **Visualization**: Existing VTK visualization tools ‚úÖ

## üß™ **Testing Results**

### **Successful Test Run:**
- ‚úÖ **CSV Initial State Loading**: 13 cells with 106 gene states loaded successfully
- ‚úÖ **CSV Export**: `cells_step_-00001.csv` generated with complete gene network data
- ‚úÖ **Decoupled Plotting**: Independent visualization tool working correctly
- ‚úÖ **Gene Network Integration**: All 106 nodes from BND file included and exported
- ‚úÖ **Coordinate System**: Logical grid positions correctly exported
- ‚úÖ **Metadata**: Proper headers with timestamp, cell count, and coordinate system info

### **Test Configuration:**
- **Domain**: 200x200 um, 10x10 grid, 2D
- **Substances**: Lactate, Glucose with proper diffusion
- **Gene Network**: 106 nodes from `jaya_microc.bnd`
- **Export Interval**: Every 2 steps
- **Output**: `results/csv_export_test/csv_cells/` and `csv_substances/`

## üéØ **Benefits**

### **For 2D Simulations:**
- **Human-Readable**: CSV format is easily inspected and processed
- **Complete Data**: All gene states and substance concentrations exported
- **Flexible Analysis**: Standard CSV tools can be used for analysis
- **Decoupled Visualization**: Plots can be generated independently

### **For Development:**
- **Debugging**: Easy to inspect cell states and gene networks
- **Validation**: Compare initial conditions with simulation results
- **Analysis**: Standard data science tools work with CSV format
- **Reproducibility**: Clear data format for sharing and validation

## üìã **Next Steps**

1. **Documentation**: Add CSV export examples to main README
2. **Testing**: Run longer simulations to test substance field export
3. **Optimization**: Consider compression for large CSV files
4. **Integration**: Add CSV export to existing test suites

## üîó **Related Files**

- `tools/csv_cell_generator.py`: Enhanced with complete gene network support
- `run_microc.py`: Master Runner with `--genes` flag for BND file integration
- `src/io/initial_state.py`: CSV loading functionality (existing)
- `tests/csv_export_test/`: Complete test configuration and files

---

**Status**: ‚úÖ **COMPLETE** - CSV export and decoupled plotting fully implemented and tested
